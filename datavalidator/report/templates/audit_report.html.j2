<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>DataValidator Report</title>
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --ink: #17212b;
      --muted: #5b6672;
      --line: #d9e0e6;
      --hi: #b3261e;
      --med: #b7791f;
      --low: #20744a;
      --info: #1f5fa8;
      --accent1: #1f6f8b;
      --accent2: #2f8f9d;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at top right, #dfe8ef 0%, var(--bg) 40%, var(--bg) 100%);
      color: var(--ink);
      font-family: "Segoe UI", "Trebuchet MS", Arial, sans-serif;
    }
    .hero {
      background: linear-gradient(110deg, var(--accent1), var(--accent2));
      color: #fff;
      border-radius: 14px;
      padding: 22px;
      margin-bottom: 16px;
      box-shadow: 0 10px 24px rgba(31, 111, 139, 0.22);
    }
    .hero h1 { margin: 0 0 8px 0; font-size: 28px; }
    .hero p { margin: 0; opacity: 0.96; }
    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      margin-bottom: 14px;
    }
    .kpi {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
    }
    .kpi .label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .05em; }
    .kpi .value { font-size: 24px; font-weight: 700; margin-top: 6px; }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    }
    .card h2 { margin: 0 0 10px 0; font-size: 18px; }

    .badge {
      display: inline-block;
      border: 1px solid var(--line);
      background: #f9fbfc;
      border-radius: 999px;
      padding: 3px 10px;
      margin: 0 6px 6px 0;
      font-size: 12px;
    }

    .sev-HIGH { border-left: 6px solid var(--hi); }
    .sev-MED { border-left: 6px solid var(--med); }
    .sev-LOW { border-left: 6px solid var(--low); }
    .sev-INFO { border-left: 6px solid var(--info); }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--line); padding: 8px; text-align: left; vertical-align: top; }
    th { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .04em; }

    pre {
      background: #f2f5f8;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 10px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      margin: 8px 0;
    }
    code { background: #f2f5f8; border-radius: 4px; padding: 1px 5px; }
    details { margin-top: 8px; }
    summary { cursor: pointer; }
  </style>
</head>
<body>

{% set high = findings | selectattr("severity","equalto","HIGH") | list | length %}
{% set med = findings | selectattr("severity","equalto","MED") | list | length %}
{% set low = findings | selectattr("severity","equalto","LOW") | list | length %}
{% set info = findings | selectattr("severity","equalto","INFO") | list | length %}

<div class="hero">
  <h1>DataValidator Audit Report</h1>
  <p><b>Project:</b> {{ inventory.project.name if inventory.project else "?" }} | <b>Root:</b> {{ inventory.project.rootDir if inventory.project and inventory.project.rootDir is defined else inventory.rootDir }}</p>
</div>

<div class="grid">
  <div class="kpi"><div class="label">Findings</div><div class="value">{{ findings|length }}</div></div>
  <div class="kpi"><div class="label">High</div><div class="value">{{ high }}</div></div>
  <div class="kpi"><div class="label">Med</div><div class="value">{{ med }}</div></div>
  <div class="kpi"><div class="label">Low</div><div class="value">{{ low }}</div></div>
  <div class="kpi"><div class="label">Info</div><div class="value">{{ info }}</div></div>
  <div class="kpi"><div class="label">PQ Items</div><div class="value">{{ (signals.powerQuery.count if signals.powerQuery else 0) }}</div></div>
</div>

<div class="card">
  <h2>Data Sources</h2>
  {% if signals.sources and signals.sources.connectors %}
    {% for c in signals.sources.connectors %}
      <span class="badge">{{ c.name }} ({{ c.count }})</span>
    {% endfor %}
    <p><b>Multiple sources used:</b> {{ "Yes" if signals.sources.multipleSources else "No" }}</p>
    <details>
      <summary><b>Sources by table</b></summary>
      <table>
        <thead><tr><th>Table</th><th>Sources</th></tr></thead>
        <tbody>
          {% for row in (signals.sources.tableSources or []) %}
          <tr>
            <td>{{ row.table }}</td>
            <td>{{ row.sources | join(", ") }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </details>
  {% else %}
    <p>No source signatures detected from extracted M snippets.</p>
  {% endif %}
</div>

<div class="card">
  <h2>Power Query Snapshot</h2>
  <p><b>Incremental refresh status:</b> {% if signals.incremental and signals.incremental.hasRangeParamsOrRefs %}Range parameters/references detected{% else %}Not configured (optional){% endif %}</p>
  <p><b>Parameter names:</b> {{ (signals.parameters.names | join(", ")) if signals.parameters and signals.parameters.names else "None" }}</p>
  <p><b>Hardcoded source hits:</b> {{ signals.hardcoding.count if signals.hardcoding else 0 }}</p>

  <details>
    <summary><b>Top folding breakers</b></summary>
    {% if signals.powerQuery and signals.powerQuery.topFoldingBreakers %}
      <ul>
      {% for b in signals.powerQuery.topFoldingBreakers %}
        <li>{{ b.pattern }} ({{ b.count }})</li>
      {% endfor %}
      </ul>
    {% else %}
      <p>No breaker patterns detected.</p>
    {% endif %}
  </details>

  <details>
    <summary><b>Parameterization coverage</b></summary>
    <table>
      <thead><tr><th>Table</th><th>Status</th></tr></thead>
      <tbody>
      {% for s in (signals.hardcoding.sourceCoverage if signals.hardcoding and signals.hardcoding.sourceCoverage else []) %}
        <tr><td>{{ s.table }}</td><td>{{ s.status }}</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </details>
</div>

<div class="card">
  <h2>Naming Convention</h2>
  <p><b>Dominant style:</b> {{ signals.naming.dominantTableStyle if signals.naming else "Unknown" }}</p>
  <p><b>Coverage:</b> {{ ("%.0f%%"|format((signals.naming.dominantCoverage or 0) * 100)) if signals.naming else "0%" }}</p>
  {% if signals.naming and signals.naming.tableStyles %}
    {% for name, count in signals.naming.tableStyles.items() %}
      <span class="badge">{{ name }}: {{ count }}</span>
    {% endfor %}
  {% endif %}
  <details>
    <summary><b>Outliers</b></summary>
    <ul>
      {% for t in (signals.naming.outlierTables if signals.naming and signals.naming.outlierTables else []) %}
      <li>{{ t }}</li>
      {% endfor %}
    </ul>
  </details>
</div>

<div class="card">
  <h2>Findings (All)</h2>
  {% if findings|length == 0 %}
    <p>No findings generated.</p>
  {% endif %}
  {% for f in findings %}
    <div class="card sev-{{ f.severity }}">
      <div><b>[{{ f.severity }}]</b> {{ f.id }} - {{ f.title }}</div>
      <p>{{ f.message }}</p>
      <p><b>Recommendation:</b> {{ f.recommendation }}</p>
      {% if f.evidence %}
      <details>
        <summary><b>Evidence</b></summary>
        <pre>{{ f.evidence | tojson(indent=2) }}</pre>
      </details>
      {% endif %}
    </div>
  {% endfor %}
</div>

{% if signals.ai and signals.ai.powerQuery %}
  {% set ai = signals.ai.powerQuery %}
  <div class="card">
    <h2>AI Review</h2>
    <p><b>Summary:</b> {{ ai.summary }}</p>

    <details open>
      <summary><b>AI Findings</b></summary>
      <ol>
        {% for f in (ai.findings if ai.findings is defined else []) %}
          <li>
            <b>[{{ f.severity }}]</b> {{ f.title }}<br/>
            <i>Why it matters:</i> {{ f.why_it_matters }}
            <pre>{{ f.evidence | tojson(indent=2) }}</pre>
            <i>Fix steps:</i>
            <ul>
              {% for s in (f.fix_steps if f.fix_steps is defined else []) %}
                <li>{{ s }}</li>
              {% endfor %}
            </ul>
          </li>
        {% endfor %}
      </ol>
    </details>

    <details>
      <summary><b>Quick Wins</b></summary>
      <ul>
        {% for w in (ai.quick_wins if ai.quick_wins is defined else []) %}
          <li>{{ w }}</li>
        {% endfor %}
      </ul>
    </details>

    <details>
      <summary><b>Questions for Dev</b></summary>
      <ul>
        {% for q in (ai.questions_for_dev if ai.questions_for_dev is defined else []) %}
          <li>{{ q }}</li>
        {% endfor %}
      </ul>
    </details>

    {% if ai.raw is defined %}
      <details>
        <summary><b>Raw AI Output</b></summary>
        <pre>{{ ai.raw }}</pre>
      </details>
    {% endif %}
  </div>
{% endif %}

</body>
</html>
